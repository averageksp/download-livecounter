name: Track Mod Downloads

on:
  workflow_dispatch:
  schedule:
    - cron: '0 12 * * *'  # Every day at noon UTC
  push:
    paths:
      - '.github/workflows/track-downloads.yml'

jobs:
  update-history:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Fetch CKAN download_counts.json
        run: curl -s https://raw.githubusercontent.com/KSP-CKAN/CKAN-meta/main/download_counts.json -o download_counts.json

      - name: Parse and update history
        run: |
          MODS=("KerbalChecklists" "WasdMainMenu" "RP-1-Checklists")
          TODAY=$(date +%F)
          jq -n --arg date "$TODAY" \
            --argjson source "$(cat download_counts.json)" \
            '{
              date: $date
            } + (reduce ["KerbalChecklists", "WasdMainMenu", "RP-1-Checklists"][] as $mod ({}; .[$mod] = ($source[$mod] // 0)))' > new_entry.json

          if [ -f history.json ]; then
            jq '. + [input]' history.json new_entry.json > combined.json
          else
            jq -n --slurpfile new new_entry.json '$new' > combined.json
          fi

          mv combined.json history.json

      - name: Commit and Push
        uses: EndBug/add-and-commit@v9
        with:
          message: "ðŸ“Š Update download history"
          add: "history.json"
