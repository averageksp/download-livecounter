<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mod Download Badge</title>
</head>
<body>
<script>
const mods = {
  kerbalchecklists: {
    github: "YourUsername/kerbalchecklists", // Replace with your actual username
    spacedock: 3855
  },
  // Add more mods here like:
  // "modname": { github: "user/repo", spacedock: ID }
};

function createBadge(label, value) {
  return `
    <svg xmlns="http://www.w3.org/2000/svg" width="160" height="20">
      <linearGradient id="b" x2="0" y2="100%">
        <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
        <stop offset="1" stop-opacity=".1"/>
      </linearGradient>
      <mask id="a">
        <rect width="160" height="20" rx="3" fill="#fff"/>
      </mask>
      <g mask="url(#a)">
        <rect width="90" height="20" fill="#555"/>
        <rect x="90" width="70" height="20" fill="#4c1"/>
        <rect width="160" height="20" fill="url(#b)"/>
      </g>
      <g fill="#fff" text-anchor="middle" font-family="Verdana" font-size="11">
        <text x="45" y="14">${label}</text>
        <text x="125" y="14">${value}</text>
      </g>
    </svg>
  `;
}

async function getDownloads(mod) {
  if (!mods[mod]) {
    document.body.innerHTML = "Unknown mod.";
    return;
  }

  const { github, spacedock } = mods[mod];
  let githubDl = 0, spacedockDl = 0;

  try {
    const ghRes = await fetch(`https://api.github.com/repos/${github}/releases`);
    const ghJson = await ghRes.json();
    githubDl = ghJson.reduce((sum, r) =>
      sum + (r.assets?.reduce((aSum, a) => aSum + a.download_count, 0) || 0), 0);
  } catch (e) {
    githubDl = 0;
  }

  try {
    const sdRes = await fetch(`https://spacedock.info/api/mod/${spacedock}`);
    const sdJson = await sdRes.json();
    spacedockDl = sdJson.downloads || 0;
  } catch (e) {
    spacedockDl = 0;
  }

  const total = githubDl + spacedockDl;
  const svg = createBadge("downloads", total);
  const blob = new Blob([svg], { type: "image/svg+xml" });

  // Force content as image/svg+xml
  document.write(svg);
}

const params = new URLSearchParams(window.location.search);
const mod = params.get("mod");
if (mod) {
  getDownloads(mod.toLowerCase());
} else {
  document.body.textContent = "No mod specified.";
}
</script>
</body>
</html>
